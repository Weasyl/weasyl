#!/bin/sh -eu

sha_disk=$(shasum -ba256 Dockerfile)
sha_docker=$(docker inspect --type image --format='{{or .Config.Labels.Sha256 ""}}' wzl 2>/dev/null || true)
if [ "${sha_disk}" != "${sha_docker}" ]; then
    docker build --tag=wzl --label="Sha256=${sha_disk}" .
fi

sock="/var/run/docker.sock"
extra_args=""
if [ -n "${DOCKER_CERT_PATH-}" ]; then
    extra_args="-v ${DOCKER_CERT_PATH}:/root/.docker -e DOCKER_TLS_VERIFY=1 ${extra_args}"
fi
if [ -n "${DOCKER_HOST-}" ]; then
    extra_args="-e DOCKER_HOST=${DOCKER_HOST} ${extra_args}"
elif [ -S "${sock}" ]; then
    extra_args="-v ${sock}:${sock} ${extra_args}"
fi

h=$(pwd)
exec docker run --rm -it \
     --name wzl-run \
     -e WZL=dev \
     -e LOCAL_USER_ID="${LOCAL_USER_ID-$(id -u)}" \
     -v "${h}:/weasyl-src" \
     -v "${h}/build:/weasyl-app/build" \
     -v "${h}/config:/weasyl-app/config" \
     -v "${h}/static:/weasyl-app/static" \
     -v "${h}/wheelhouse:/wheelhouse" \
     ${extra_args} \
     wzl "$@"
