Commands
======================

Some of the more common commands that might be needed during development can be found on this page.


## Prerequisites
- [Docker](https://docs.docker.com/engine/install/)
- [`docker compose`](https://docs.docker.com/compose/install/)


## From zero to devlopment
When within a cloned Weasyl repository, execute the following to build everything.

```shell
# Downloads a copy of the sample database
wget https://pypi.weasyl.dev/02-weasyl-latest-staff.sql.gz -O containers/postgres/02-weasyl-latest-staff.sql.gz
# Creates configuration from sample configuration
./wzl configure
# Runs database migrations
./wzl migrate
# Copies assets
./wzl assets
# Starts remaining Weasyl services in the background
./wzl up -d
```

Weasyl should now be running at http://weasyl.localhost:8080/.


## `./wzl`

The `wzl` script within the repository root is -- essentially -- a wrapper for `docker compose`, and is used to provide a uniform development environment.


### Starting Weasyl
To start Weasyl, the following command will bring up Weasyl in the background.
```shell
./wzl up --detach
```

Executing in the foreground is possible as well, which might be useful if actively attempting to debug or diagnose an issue, via the following command.
```shell
./wzl up
```

Applying changes to the application server may be done by appending `--build web` to `wzl up`.
```shell
./wzl up --detach --build web
```


### Running tests
The following will run the Weasyl test suite.
```shell
./wzl test
```


### Database migrations
Weasyl uses PostgreSQL as the database backend, and [Alembic](https://alembic.sqlalchemy.org/en/latest/) to perform database migrations. The process to create a change to the Weasyl database is:
1. Edit the model files located within `libweasyl/models`.
2. Execute the following command to create an Alembic revision file:
```shell
./wzl revision --autogenerate -m 'Revision summary'
```
3. Edit the autogenerated file within `libweasyl/alembic/versions`, and ensure that the generated migration is correct.
4. Test the revision by using the steps outlined in [migrating the database](#Migrating the database), below.


### Migrating the database
To apply a database migration file created from `./wzl revision`, execute the following command:
```shell
./wzl migrate
```

### Viewing docker container logs
The command `./wzl logs <container name>` may be used to view the logs for that container (as one would with the `docker logs` command). For instance, to view the web logs on a detached instance of Weasyl (e.g., `./wzl up --detach` was run):
```shell
./wzl logs web
```

### Inspecting the PostgreSQL database
To execute commands against the PostgreSQL database directly, execute the following.
```shell
./wzl exec postgres psql -U weasyl
```
