#!/bin/sh -eu

if [ ! ".stamp-wzl" -nt "Dockerfile" ]; then
    docker build -t wzl .
    touch .stamp-wzl
fi

sock="/var/run/docker.sock"
extra_args=""
if [ -n "${DOCKER_CERT_PATH}" ]; then
    extra_args="-v ${DOCKER_CERT_PATH}:/root/.docker -e DOCKER_TLS_VERIFY=1 ${extra_args}"
fi
if [ -n "${DOCKER_HOST}" ]; then
    extra_args="-e DOCKER_HOST=${DOCKER_HOST} ${extra_args}"
elif [ -S "${sock}" ]; then
    extra_args="-v ${sock}:${sock} ${extra_args}"
fi

h=$(pwd)
exec docker run --rm -it \
     --name wzl-run \
     -e WZL=dev \
     -v "${h}:/weasyl-src" \
     -v "${h}/config:/weasyl-app/config" \
     -v "${h}/static:/weasyl-app/static" \
     -v "${h}/wheelhouse:/wheelhouse" \
     ${extra_args} \
     wzl "$@"
