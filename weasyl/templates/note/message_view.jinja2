{% extends 'common/base.jinja2' %}
{% from 'common/stage_title.jinja2' import stage %}
{% block content %}
{{ stage("View Private Message", "Notes", "/notes?folder=%s" % ("outbox" if query['mine'] else "inbox")) }}
<div id="note-content" class="content">

  <div class="constrained">
    <dl class="clear">
      <dt>Sender:</dt>
      <dd>
        <a href="/~{{ query['sendername'] | LOGIN }}" class="username">{{ query['sendername'] }}</a>

        {% set user_type = USER_TYPE(query['senderid']) %}
        {% if user_type %}
          <strong class="user-type-{{ user_type }}">({{ user_type }})</strong>
        {% endif %}
      </dd>

      <dt>Recipient:</dt>
      <dd>
        <a href="/~{{ query['recipientname'] | LOGIN }}" class="username">{{ query['recipientname'] }}</a>

        {% set user_type = USER_TYPE(query['recipientid']) %}
        {% if user_type %}
          <strong class="user-type-{{ user_type }}}">({{ user_type }})</strong>
        {% endif %}
      </dd>

      <dt>Date:</dt>
      <dd>{{ query['unixtime'] | DATE }} {{ query['unixtime'] | TIME }}</dd>

      <dt>Subject:</dt>
      <dd>{{ query['title'] }}</dd>
    </dl>

    <div class="formatted-content">{{ query['content'] | MARKDOWN }}</div>

    {% if myself['is_mod'] %}
      <form action="/modcontrol/copynotetostaffnotes" method="post" class="form clear">
        <button class="button" style="float: right;">Copy Note to Staff Notes</button>
        <input type="hidden" name="noteid" value="{{ query['noteid'] }}" />
        <input type="hidden" name="token" value="{{ TOKEN() }}"/>
      </form>
    {% endif %}

    {% if not query['mine'] %}
      <form name="notescompose" action="/notes/compose" method="post" class="form clear">
        <input type="hidden" name="token" value="{{ TOKEN() }}"/>

        <h3>Send Reply</h3>

        <label for="notereplyrecipient">Recipient</label>
        <input type="text" class="input" name="recipient" value="{{ query['sendername'] | LOGIN }}" id="notereplyrecipient" />

        <label for="notereplytitle">Subject</label>
        <input type="text" name="title" class="input" value="{{'' if query['title'][:4] == 'Re: ' else 'Re: '}}{{ query['title'] }}" id="notereplytitle" />

        <label for="notereplycontent">Content</label>
        <textarea name="content" class="markdown input expanding last-input" rows="9" id="notereplycontent"></textarea>
        <br>

        {% if myself['is_mod'] %}
          <div id="note-compose-staff-note">
            <label class="input-checkbox">
              <input type="checkbox" name="mod_copy" id="mod-copy" value="y">
              Copy this note to the users' staff notes
            </label>
            <div id="staff-note-area">
              <label for="staff-note">Additional staff notes</label>
              <textarea name="staff_note" class="markdown input last-input expanding" id="staff-note" rows="4"></textarea>
            </div>
          </div>
          <br>
        {% endif %}

        <button type="submit" class="button positive" style="float: right;">Send</button>
      </form>
  {% endif %}

  </div>
</div>
{% endblock %}